{"config":{"lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Kusto Queries A steady work in progress. Be patient much more is coming.","title":"Kusto Queries"},{"location":"#kusto-queries","text":"A steady work in progress. Be patient much more is coming.","title":"Kusto Queries"},{"location":"Containers/Azure-Container-Registry/","text":"","title":"Azure Container Registry"},{"location":"Containers/Azure-Kubernetes-Service/","text":"","title":"Azure Kubernetes Service"},{"location":"Databases/Azure-SQL/","text":"Azure SQL The queries below allow you to query various diagnostic and metric data for Azure SQL Server and Azure SQL Databases. Optimal rendering options are also included below each query. Average CPU Utilization by Database List all application gateways currently being monitored. This query can be executed against AzureMetrics or AzureDiagnostics . AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"cpu_percent\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) Size in MB by Database Display the size in MB for each database. The results display the average size in increments of 1-hour blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"storage\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 1 h ) | extend AverageMB = avg_Average / 1000000 | project TimeGenerated , Resource , AverageMB Successful Connections by Database Show the number of successful connecions by database. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"connection_successful\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) Unsuccessful Connections by Database Show the number of successful connecions by database. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"connection_unsuccessful\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) Blocked Firewall Attempts by Database Show the number of connection attempts, by database, block by the firewall. The results display the average number of blocks in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"blocked_by_firewall\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) CPU Utilization Percentage by Database Display the CPU utilization percentage by database. The results display the average utilization in increments of 1-minute blocks for the past 1 hour. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 1 h ) | where MetricName == \"cpu_used\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 1 m ) | extend AvgCPU = avg_Average * 100 | project TimeGenerated , Resource , AvgCPU List All SQL Vulnerabilities List all SQL vulnerabilities, sorted from 'High' risk to 'Low' riskk, from the last 3 days. let results = SqlVulnerabilityAssessmentResult | where TimeGenerated > ago ( 72 h ) | distinct Computer , DatabaseName , Title , Risk , Category , Description , Impact , Query , Remediation , BenchmarkReferences ; results | extend RiskLevel = 1 | where Risk == \"High\" | union ( results | extend RiskLevel = 2 | where Risk == \"Medium\" ) | union ( results | extend RiskLevel = 3 | where Risk == \"Low\" ) | order by RiskLevel asc SQL Vulnerability List with Count by Database let results = SqlVulnerabilityAssessmentResult | where TimeGenerated > ago ( 72 h ) | summarize count () by Computer , DatabaseName , Risk ; results | extend RiskLevel = 1 | where Risk == \"High\" | union ( results | extend RiskLevel = 2 | where Risk == \"Medium\" ) | union ( results | extend RiskLevel = 3 | where Risk == \"Low\" ) | order by RiskLevel asc SQL Vulnerability List with Count by Database SqlVulnerabilityAssessmentResult | where TimeGenerated > ago(72h) | summarize count() by DatabaseName SQL Vulnerability List with Count by Risk Level SqlVulnerabilityAssessmentResult | where TimeGenerated > ago ( 72 h ) | summarize count () by DatabaseName","title":"Azure SQL"},{"location":"Databases/Azure-SQL/#azure-sql","text":"The queries below allow you to query various diagnostic and metric data for Azure SQL Server and Azure SQL Databases. Optimal rendering options are also included below each query.","title":"Azure SQL"},{"location":"Databases/Azure-SQL/#average-cpu-utilization-by-database","text":"List all application gateways currently being monitored. This query can be executed against AzureMetrics or AzureDiagnostics . AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"cpu_percent\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m )","title":"Average CPU Utilization by Database"},{"location":"Databases/Azure-SQL/#size-in-mb-by-database","text":"Display the size in MB for each database. The results display the average size in increments of 1-hour blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"storage\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 1 h ) | extend AverageMB = avg_Average / 1000000 | project TimeGenerated , Resource , AverageMB","title":"Size in MB by Database"},{"location":"Databases/Azure-SQL/#successful-connections-by-database","text":"Show the number of successful connecions by database. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"connection_successful\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Successful Connections by Database"},{"location":"Databases/Azure-SQL/#unsuccessful-connections-by-database","text":"Show the number of successful connecions by database. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"connection_unsuccessful\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Unsuccessful Connections by Database"},{"location":"Databases/Azure-SQL/#blocked-firewall-attempts-by-database","text":"Show the number of connection attempts, by database, block by the firewall. The results display the average number of blocks in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 24 h ) | where MetricName == \"blocked_by_firewall\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Blocked Firewall Attempts by Database"},{"location":"Databases/Azure-SQL/#cpu-utilization-percentage-by-database","text":"Display the CPU utilization percentage by database. The results display the average utilization in increments of 1-minute blocks for the past 1 hour. AzureMetrics | where ResourceProvider == \"MICROSOFT.SQL\" and Resource != \"MASTER\" | where TimeGenerated > ago ( 1 h ) | where MetricName == \"cpu_used\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 1 m ) | extend AvgCPU = avg_Average * 100 | project TimeGenerated , Resource , AvgCPU","title":"CPU Utilization Percentage by Database"},{"location":"Databases/Azure-SQL/#list-all-sql-vulnerabilities","text":"List all SQL vulnerabilities, sorted from 'High' risk to 'Low' riskk, from the last 3 days. let results = SqlVulnerabilityAssessmentResult | where TimeGenerated > ago ( 72 h ) | distinct Computer , DatabaseName , Title , Risk , Category , Description , Impact , Query , Remediation , BenchmarkReferences ; results | extend RiskLevel = 1 | where Risk == \"High\" | union ( results | extend RiskLevel = 2 | where Risk == \"Medium\" ) | union ( results | extend RiskLevel = 3 | where Risk == \"Low\" ) | order by RiskLevel asc","title":"List All SQL Vulnerabilities"},{"location":"Databases/Azure-SQL/#sql-vulnerability-list-with-count-by-database","text":"let results = SqlVulnerabilityAssessmentResult | where TimeGenerated > ago ( 72 h ) | summarize count () by Computer , DatabaseName , Risk ; results | extend RiskLevel = 1 | where Risk == \"High\" | union ( results | extend RiskLevel = 2 | where Risk == \"Medium\" ) | union ( results | extend RiskLevel = 3 | where Risk == \"Low\" ) | order by RiskLevel asc","title":"SQL Vulnerability List with Count by Database"},{"location":"Databases/Azure-SQL/#sql-vulnerability-list-with-count-by-database_1","text":"SqlVulnerabilityAssessmentResult | where TimeGenerated > ago(72h) | summarize count() by DatabaseName","title":"SQL Vulnerability List with Count by Database"},{"location":"Databases/Azure-SQL/#sql-vulnerability-list-with-count-by-risk-level","text":"SqlVulnerabilityAssessmentResult | where TimeGenerated > ago ( 72 h ) | summarize count () by DatabaseName","title":"SQL Vulnerability List with Count by Risk Level"},{"location":"Databases/Cosmos-DB/","text":"","title":"Cosmos DB"},{"location":"Monitoring/Application-Insights/","text":"Application Insights The queries below allow you to query various diagnostic and metric data for Application Insights Optimal rendering options are also included below each query. List Failed Requests The following query shows all requests that experienced exceptions (error 500 or greater) along with the count of exceptions thrown. The table is rendered by \"Count\" in descending order requests | where timestamp >= ago ( 1 d ) | where toint ( resultCode ) >= 500 | summarize Count = count () by name | order by Count desc","title":"Application Insights"},{"location":"Monitoring/Application-Insights/#application-insights","text":"The queries below allow you to query various diagnostic and metric data for Application Insights Optimal rendering options are also included below each query.","title":"Application Insights"},{"location":"Monitoring/Application-Insights/#list-failed-requests","text":"The following query shows all requests that experienced exceptions (error 500 or greater) along with the count of exceptions thrown. The table is rendered by \"Count\" in descending order requests | where timestamp >= ago ( 1 d ) | where toint ( resultCode ) >= 500 | summarize Count = count () by name | order by Count desc","title":"List Failed Requests"},{"location":"Monitoring/Security-Center/","text":"","title":"Security Center"},{"location":"Networking/Application-Gateway/","text":"Application Gateway The queries below allow you to query various diagnostic and metric data for the Application Gateway, including the Web Application Firewall. These queries have been updated to be compatible with WAF v2. Optimal rendering options are also included below each query. List Monitored Application Gateways (individual list) List all application gateways currently being monitored. This query can be executed against AzureMetrics or AzureDiagnostics . AzureMetrics AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup AzureDiagnostics AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup List Monitored Application Gateways (comparitive list - join) List all application gateways currently being monitored. This query joins both, AzureMetrics and AzureDiagnostics , to create an all-inclusive list of gateways being monitored. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup | as Metrics | union withsource = Source ( AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup | as Diagnostics ) List Unmonitored Application Gateways (XOR list) List all application gateways currently being monitored, but only have one setting turned on - either AzureMetrics or AzureDiagnostics - but, not both. This creates a union of outer joins against both tables and returns results that are exclusive to either table and not found in both. Additionally, the query reports which setting is missing for the application gateway. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup | join kind = leftanti ( AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup ) on Resource , ResourceGroup | as Diagnostics | union withsource = MissingSetting ( AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup | join kind = rightanti ( AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup ) on Resource , ResourceGroup | as Metrics ) | project Resource , ResourceGroup , MissingSetting Average Throughput per second (Bytes) Display the average throughput per second of the application gateways. The results display the average of 5-minute blocks by each application gateway resource. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"Throughput\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) | project TimeGenerated , avg_Average , Resource Average Throughput per second (Mb) The same as the query above, but converted to megabytes (Base 10). AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"Throughput\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) | extend ThroughputMb = todecimal (( avg_Average / 1000 ) / 1000 ) | project TimeGenerated , ThroughputMb , Resource Unhealthy Hosts (Compared to Healthy) Show when hosts connected to the application gateway become unreachable. This query will produce a comparison graph between the number of nodes that are healthy and those that are unhealthy for a single application gateway. The results display the average health in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" and Resource == \"<your gateway's name>\" | where MetricName == \"UnhealthyHostCount\" or MetricName == \"HealthyHostCount\" | summarize avg ( Total ) by Resource , MetricName , bin ( TimeGenerated , 5 m ) | project TimeGenerated , MetricName , avg_Total Unhealthy Hosts (for all gateways) Show when hosts connected to the application gateway become unreachable. This query will produce the number of nodes that are unhealthy for all application gateways. The results display the average disconnected state in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"UnhealthyHostCount\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) | project TimeGenerated , Resource , avg_Total Healthy Hosts (for all gateways) Show healthy, reachable hosts connected to the application gateway. This query will produce the number of nodes that are healthy for all application gateways. The results display the average connected state in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"HealthyHostCount\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) | project TimeGenerated , Resource , avg_Total All Errors (by gateway) Display requests that resulted in some type of error (error code 400 or above). AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | extend Status = toint ( httpStatus_d ) | where Status >= 400 | summarize Count = count () by tostring ( Status ), Resource | project Resource , Status , Count All Errors (by backend) Display requests that resulted in some type of error (error code 400 or above). AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | extend Status = toint ( serverStatus_s ) | extend Server = serverRouted_s | where Status >= 400 | summarize Count = count () by tostring ( Status ), Server | project Server , Status , Count Bad Gateway (by gateway) Find requests that resulted in a server error of 502 - Bad Gateway . The results display the total errors in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where serverStatus_s == 502 | summarize count () by Resource , bin ( TimeGenerated , 5 m ) All Operations (for all gateways) Report all operations on the gateways in the subscription. The results display the total number of operations in increments of 15-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and ResourceType == \"APPLICATIONGATEWAYS\" | summarize count () by OperationName , bin ( TimeGenerated , 15 m ) Total Connections (by gateway) Report the number of total connections per each application gateway. The results display the total number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"CurrentConnections\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m ) Average Connection Count (by gateway) Report the number of average connections per application gateway. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"CurrentConnections\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) Average Backend Connection Time (by gateway) Report the average backend connection time per application gateway. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"BackendConnectTime\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) Average Total Time (by gateway) Report the average time for a request - beginning to end - per each application gateway. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"ApplicationGatewayTotalTime\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) Average Latency (per backend server) Report the average latency per backend servers connected to your application gateway(s). The results display the average latency in seconds of servers connected to the backend pools in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | summarize avg ( todouble ( serverResponseTime_s )) by serverRouted_s , bin ( TimeGenerated , 5 m ) Total Requests (by gateway) Report the total number of requests per application gateway. The results display the total number of requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"TotalRequests\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m ) Average Requests (by gateway) Report the average number of requests per application gateway. The results display the average number of requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"TotalRequests\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) Total Failed Requests (by gateway) Report the total number of failed requests per application gateway. The results display the total number of failed requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"FailedRequests\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m ) Average Failed Requests (by gateway) Report the average number of failed requests per application gateway. The results display the average number of failed requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"FailedRequests\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) Total Successful Requests (per backend server) Report the total number of successful requests per backend servers connected to your application gateway(s). The results display the total number of successful requests to servers connected to the backend pools in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where toint ( serverStatus_s ) < 400 | summarize count () by serverRouted_s , bin ( TimeGenerated , 5 m ) Total Failed Requests (per backend server) Report the total number of failed requests per backend servers connected to your application gateway(s). The results display the total number of failed requests to servers connected to the backend pools in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where toint ( serverStatus_s ) >= 400 | summarize count () by serverRouted_s , bin ( TimeGenerated , 5 m ) Total Requests (per API) Report the total number of requests per API endpoint. The results display the total number of requests to each served endpoint in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | summarize Count = count () by requestUri_s , bin ( TimeGenerated , 5 m ) Failed Requests (per API) Report the failed number of requests per API endpoint. The results display the failed number of requests to each served endpoint in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where httpStatus_d >= 400 | summarize Count = count () by requestUri_s , bin ( TimeGenerated , 5 m ) Failed Requests, include Status (per API) Report the failed number of requests per API endpoint. The results display the failed number of requests to each served endpoint in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where httpStatus_d >= 400 | summarize Count = count () by requestUri_s , httpsStatus_d , bin ( TimeGenerated , 5 m ) Triggered Firewall Rules Report all OWASP rules that have been triggered. The results display the triggers in increments of 5-minute blocks for the past 24 hours. AzureDiagnostis | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayFirewallLog\" | summarize Count = count () by ruleId_s , bin ( TimeGenerated , 5 m ) Blocked Firewall Rules Report all requests that resulted in a firewall block due to an OWASP rule. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayFirewallLog\" | where action_s == \"Blocked\" Count Blocked Firewall Rules Group and count all blocked requests by rule violation. The results display the triggers in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayFirewallLog\" | where action_s == \"Blocked\" | summarize Count = count () by ruleId_s , bin ( TimeGenerated , 5 m )","title":"Application Gateway"},{"location":"Networking/Application-Gateway/#application-gateway","text":"The queries below allow you to query various diagnostic and metric data for the Application Gateway, including the Web Application Firewall. These queries have been updated to be compatible with WAF v2. Optimal rendering options are also included below each query.","title":"Application Gateway"},{"location":"Networking/Application-Gateway/#list-monitored-application-gateways-individual-list","text":"List all application gateways currently being monitored. This query can be executed against AzureMetrics or AzureDiagnostics . AzureMetrics AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup AzureDiagnostics AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup","title":"List Monitored Application Gateways (individual list)"},{"location":"Networking/Application-Gateway/#list-monitored-application-gateways-comparitive-list-join","text":"List all application gateways currently being monitored. This query joins both, AzureMetrics and AzureDiagnostics , to create an all-inclusive list of gateways being monitored. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup | as Metrics | union withsource = Source ( AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Resource , ResourceGroup | as Diagnostics )","title":"List Monitored Application Gateways (comparitive list - join)"},{"location":"Networking/Application-Gateway/#list-unmonitored-application-gateways-xor-list","text":"List all application gateways currently being monitored, but only have one setting turned on - either AzureMetrics or AzureDiagnostics - but, not both. This creates a union of outer joins against both tables and returns results that are exclusive to either table and not found in both. Additionally, the query reports which setting is missing for the application gateway. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup | join kind = leftanti ( AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup ) on Resource , ResourceGroup | as Diagnostics | union withsource = MissingSetting ( AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup | join kind = rightanti ( AzureDiagnostics | where ResourceId contains \"APPLICATIONGATEWAY\" | distinct Type , Resource , ResourceGroup ) on Resource , ResourceGroup | as Metrics ) | project Resource , ResourceGroup , MissingSetting","title":"List Unmonitored Application Gateways (XOR list)"},{"location":"Networking/Application-Gateway/#average-throughput-per-second-bytes","text":"Display the average throughput per second of the application gateways. The results display the average of 5-minute blocks by each application gateway resource. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"Throughput\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) | project TimeGenerated , avg_Average , Resource","title":"Average Throughput per second (Bytes)"},{"location":"Networking/Application-Gateway/#average-throughput-per-second-mb","text":"The same as the query above, but converted to megabytes (Base 10). AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"Throughput\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m ) | extend ThroughputMb = todecimal (( avg_Average / 1000 ) / 1000 ) | project TimeGenerated , ThroughputMb , Resource","title":"Average Throughput per second (Mb)"},{"location":"Networking/Application-Gateway/#unhealthy-hosts-compared-to-healthy","text":"Show when hosts connected to the application gateway become unreachable. This query will produce a comparison graph between the number of nodes that are healthy and those that are unhealthy for a single application gateway. The results display the average health in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" and Resource == \"<your gateway's name>\" | where MetricName == \"UnhealthyHostCount\" or MetricName == \"HealthyHostCount\" | summarize avg ( Total ) by Resource , MetricName , bin ( TimeGenerated , 5 m ) | project TimeGenerated , MetricName , avg_Total","title":"Unhealthy Hosts (Compared to Healthy)"},{"location":"Networking/Application-Gateway/#unhealthy-hosts-for-all-gateways","text":"Show when hosts connected to the application gateway become unreachable. This query will produce the number of nodes that are unhealthy for all application gateways. The results display the average disconnected state in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"UnhealthyHostCount\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) | project TimeGenerated , Resource , avg_Total","title":"Unhealthy Hosts (for all gateways)"},{"location":"Networking/Application-Gateway/#healthy-hosts-for-all-gateways","text":"Show healthy, reachable hosts connected to the application gateway. This query will produce the number of nodes that are healthy for all application gateways. The results display the average connected state in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAY\" | where MetricName == \"HealthyHostCount\" | summarize avg ( Total ) by Resource , bin ( TimeGenerated , 5 m ) | project TimeGenerated , Resource , avg_Total","title":"Healthy Hosts (for all gateways)"},{"location":"Networking/Application-Gateway/#all-errors-by-gateway","text":"Display requests that resulted in some type of error (error code 400 or above). AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | extend Status = toint ( httpStatus_d ) | where Status >= 400 | summarize Count = count () by tostring ( Status ), Resource | project Resource , Status , Count","title":"All Errors (by gateway)"},{"location":"Networking/Application-Gateway/#all-errors-by-backend","text":"Display requests that resulted in some type of error (error code 400 or above). AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | extend Status = toint ( serverStatus_s ) | extend Server = serverRouted_s | where Status >= 400 | summarize Count = count () by tostring ( Status ), Server | project Server , Status , Count","title":"All Errors (by backend)"},{"location":"Networking/Application-Gateway/#bad-gateway-by-gateway","text":"Find requests that resulted in a server error of 502 - Bad Gateway . The results display the total errors in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where serverStatus_s == 502 | summarize count () by Resource , bin ( TimeGenerated , 5 m )","title":"Bad Gateway (by gateway)"},{"location":"Networking/Application-Gateway/#all-operations-for-all-gateways","text":"Report all operations on the gateways in the subscription. The results display the total number of operations in increments of 15-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and ResourceType == \"APPLICATIONGATEWAYS\" | summarize count () by OperationName , bin ( TimeGenerated , 15 m )","title":"All Operations (for all gateways)"},{"location":"Networking/Application-Gateway/#total-connections-by-gateway","text":"Report the number of total connections per each application gateway. The results display the total number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"CurrentConnections\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Total Connections (by gateway)"},{"location":"Networking/Application-Gateway/#average-connection-count-by-gateway","text":"Report the number of average connections per application gateway. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"CurrentConnections\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m )","title":"Average Connection Count (by gateway)"},{"location":"Networking/Application-Gateway/#average-backend-connection-time-by-gateway","text":"Report the average backend connection time per application gateway. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"BackendConnectTime\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m )","title":"Average Backend Connection Time (by gateway)"},{"location":"Networking/Application-Gateway/#average-total-time-by-gateway","text":"Report the average time for a request - beginning to end - per each application gateway. The results display the average number of connections in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"ApplicationGatewayTotalTime\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m )","title":"Average Total Time (by gateway)"},{"location":"Networking/Application-Gateway/#average-latency-per-backend-server","text":"Report the average latency per backend servers connected to your application gateway(s). The results display the average latency in seconds of servers connected to the backend pools in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | summarize avg ( todouble ( serverResponseTime_s )) by serverRouted_s , bin ( TimeGenerated , 5 m )","title":"Average Latency (per backend server)"},{"location":"Networking/Application-Gateway/#total-requests-by-gateway","text":"Report the total number of requests per application gateway. The results display the total number of requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"TotalRequests\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Total Requests (by gateway)"},{"location":"Networking/Application-Gateway/#average-requests-by-gateway","text":"Report the average number of requests per application gateway. The results display the average number of requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"TotalRequests\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m )","title":"Average Requests (by gateway)"},{"location":"Networking/Application-Gateway/#total-failed-requests-by-gateway","text":"Report the total number of failed requests per application gateway. The results display the total number of failed requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"FailedRequests\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Total Failed Requests (by gateway)"},{"location":"Networking/Application-Gateway/#average-failed-requests-by-gateway","text":"Report the average number of failed requests per application gateway. The results display the average number of failed requests in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"APPLICATIONGATEWAYS\" | where MetricName == \"FailedRequests\" | summarize avg ( Average ) by Resource , bin ( TimeGenerated , 5 m )","title":"Average Failed Requests (by gateway)"},{"location":"Networking/Application-Gateway/#total-successful-requests-per-backend-server","text":"Report the total number of successful requests per backend servers connected to your application gateway(s). The results display the total number of successful requests to servers connected to the backend pools in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where toint ( serverStatus_s ) < 400 | summarize count () by serverRouted_s , bin ( TimeGenerated , 5 m )","title":"Total Successful Requests (per backend server)"},{"location":"Networking/Application-Gateway/#total-failed-requests-per-backend-server","text":"Report the total number of failed requests per backend servers connected to your application gateway(s). The results display the total number of failed requests to servers connected to the backend pools in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where toint ( serverStatus_s ) >= 400 | summarize count () by serverRouted_s , bin ( TimeGenerated , 5 m )","title":"Total Failed Requests (per backend server)"},{"location":"Networking/Application-Gateway/#total-requests-per-api","text":"Report the total number of requests per API endpoint. The results display the total number of requests to each served endpoint in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | summarize Count = count () by requestUri_s , bin ( TimeGenerated , 5 m )","title":"Total Requests (per API)"},{"location":"Networking/Application-Gateway/#failed-requests-per-api","text":"Report the failed number of requests per API endpoint. The results display the failed number of requests to each served endpoint in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where httpStatus_d >= 400 | summarize Count = count () by requestUri_s , bin ( TimeGenerated , 5 m )","title":"Failed Requests (per API)"},{"location":"Networking/Application-Gateway/#failed-requests-include-status-per-api","text":"Report the failed number of requests per API endpoint. The results display the failed number of requests to each served endpoint in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayAccessLog\" | where httpStatus_d >= 400 | summarize Count = count () by requestUri_s , httpsStatus_d , bin ( TimeGenerated , 5 m )","title":"Failed Requests, include Status (per API)"},{"location":"Networking/Application-Gateway/#triggered-firewall-rules","text":"Report all OWASP rules that have been triggered. The results display the triggers in increments of 5-minute blocks for the past 24 hours. AzureDiagnostis | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayFirewallLog\" | summarize Count = count () by ruleId_s , bin ( TimeGenerated , 5 m )","title":"Triggered Firewall Rules"},{"location":"Networking/Application-Gateway/#blocked-firewall-rules","text":"Report all requests that resulted in a firewall block due to an OWASP rule. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayFirewallLog\" | where action_s == \"Blocked\"","title":"Blocked Firewall Rules"},{"location":"Networking/Application-Gateway/#count-blocked-firewall-rules","text":"Group and count all blocked requests by rule violation. The results display the triggers in increments of 5-minute blocks for the past 24 hours. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ApplicationGatewayFirewallLog\" | where action_s == \"Blocked\" | summarize Count = count () by ruleId_s , bin ( TimeGenerated , 5 m )","title":"Count Blocked Firewall Rules"},{"location":"Networking/Load-Balancer/","text":"","title":"Load Balancer"},{"location":"Networking/Traffic-Manager/","text":"Traffic Manager The queries below allow you to query various diagnostic and metric data for a Traffic Manager Profile. Optimal rendering options are also included below each query. Status Report (by profile) Reports the status of a Traffic Manager Profile endpoint. For each profile, the query reports either a 1 for the endpoint being Up or 0 for the endpoint being Down . Being that a downstate is a high-priority incident, the results display the minimum (e.g. 0 ) of 1-minute blocks by each traffic manager profile. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ProbeHealthStatusEvents\" | extend Endpoint = strcat ( Resource , \"/\" , EndpointName_s ) | extend Up = case ( Status_s == \"Up\" , 1 , 0 ) | summarize min ( Up ) by Endpoint , bin ( TimeGenerated , 1 m ) List Down Endpoints (by profile) Reports all Traffic Manager Profile endpoints that have been reported as \"Down\" within the past 5 minutes. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ProbeHealthStatusEvents\" | where Status_s == \"Down\" | where TimeGenerated > ago ( 5 m ) | extend Endpoint = strcat ( Resource , \"/\" , EndpointName_s ) | project Endpoint | distinct Endpoint Total Queries by Endpoint (by profile) Displays the total number of queries by endpoint. The results display the query count in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"TRAFFICMANAGERPROFILE\" | where MetricName == \"QpsByEndpoint\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Traffic Manager"},{"location":"Networking/Traffic-Manager/#traffic-manager","text":"The queries below allow you to query various diagnostic and metric data for a Traffic Manager Profile. Optimal rendering options are also included below each query.","title":"Traffic Manager"},{"location":"Networking/Traffic-Manager/#status-report-by-profile","text":"Reports the status of a Traffic Manager Profile endpoint. For each profile, the query reports either a 1 for the endpoint being Up or 0 for the endpoint being Down . Being that a downstate is a high-priority incident, the results display the minimum (e.g. 0 ) of 1-minute blocks by each traffic manager profile. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ProbeHealthStatusEvents\" | extend Endpoint = strcat ( Resource , \"/\" , EndpointName_s ) | extend Up = case ( Status_s == \"Up\" , 1 , 0 ) | summarize min ( Up ) by Endpoint , bin ( TimeGenerated , 1 m )","title":"Status Report (by profile)"},{"location":"Networking/Traffic-Manager/#list-down-endpoints-by-profile","text":"Reports all Traffic Manager Profile endpoints that have been reported as \"Down\" within the past 5 minutes. AzureDiagnostics | where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"ProbeHealthStatusEvents\" | where Status_s == \"Down\" | where TimeGenerated > ago ( 5 m ) | extend Endpoint = strcat ( Resource , \"/\" , EndpointName_s ) | project Endpoint | distinct Endpoint","title":"List Down Endpoints (by profile)"},{"location":"Networking/Traffic-Manager/#total-queries-by-endpoint-by-profile","text":"Displays the total number of queries by endpoint. The results display the query count in increments of 5-minute blocks for the past 24 hours. AzureMetrics | where ResourceId contains \"TRAFFICMANAGERPROFILE\" | where MetricName == \"QpsByEndpoint\" | summarize sum ( Total ) by Resource , bin ( TimeGenerated , 5 m )","title":"Total Queries by Endpoint (by profile)"},{"location":"Storage/Azure-Storage/","text":"Azure Storage The queries below allow you to query various diagnostic and metric data for Azure Storage. Optimal rendering options are also included below each query. List Last Regeneration of Account Keys List the last attempt and status of changing account keys (within the past 3 days) for the storage accounts. AzureActivity | where OperationName == \"Regenerate Storage Account Keys\" and ActivityStatus != \"Started\" | where TimeGenerated > ago ( 3 d ) | summarize any ( TimeGenerated ) by Resource , ActivityStatus | project - rename DateTimeStamp = any_TimeGenerated , Resource , ActivityStatus","title":"Azure Storage"},{"location":"Storage/Azure-Storage/#azure-storage","text":"The queries below allow you to query various diagnostic and metric data for Azure Storage. Optimal rendering options are also included below each query.","title":"Azure Storage"},{"location":"Storage/Azure-Storage/#list-last-regeneration-of-account-keys","text":"List the last attempt and status of changing account keys (within the past 3 days) for the storage accounts. AzureActivity | where OperationName == \"Regenerate Storage Account Keys\" and ActivityStatus != \"Started\" | where TimeGenerated > ago ( 3 d ) | summarize any ( TimeGenerated ) by Resource , ActivityStatus | project - rename DateTimeStamp = any_TimeGenerated , Resource , ActivityStatus","title":"List Last Regeneration of Account Keys"}]}